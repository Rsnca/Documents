# 初め
## バッチ処理とオンライン処理の違い
- オンライン処理：利用者からの要求を常に受付、逐次処理するシステム
- バッチ処理：システム内部で定められた手続きをもとに多量のデータを一括して処理を行うもの

## どうしてバッチ処理が必要になるのか
バッチ処理には次の2つのカテゴリがある。
- Functional Jobs
  - 業務要件をもとにした処理
  - ex) 定期的に必ずまとめて行わなければならない要件に基づいたバッチ処理
- Technical Jobs
  - 技術要件をもとにした処理
  - オンライン処理だけでは解決できなくなった場合に採用されることが多い

# バッチ処理の設計を行おう
## どうして設計が必要なのか
バッチ処理の設計には次の6つの観点が必要
1. 非機能要求に基づく実行計画
  - 所要時間やいつまでに終わる必要があるかに着目する
2. 処理件数
  - サービスインしているかどうか
    - している：下記状況での処理件数の推移を稼働開始直後、1か月後、3か月後、半年後、1年後で見積もる
      A. オンラインだったものをバッチに移行する
      B. 新しい業務を追加する際に既存のデータを利用する
    - していない：開始後をインしている状況と同じように見積もる
3. 処理時間
  A. 1件あたりどのくらいの処理時間がかかるのか
  B. 全権処理するとどのくらい処理時間がかかるのか
  C. いつ起動しいつまでに追えなければならないのか
4. 回復可能
  - バッチ処理でトラブルが起きた時、障害となった原因を取り除いた後、再実行することが基本となる
  - その時、以下に気をつけて実行しないと重複処理などでデータの不整合が生じる場合原因となる
  A. 処理未完了ステータスのものだけに絞って処理する
  B. すべてのレコードを処理するが処理完了のものは二重に処理しないよう結果の冪等性を担保する
  C. 最後に処理したレコードが何らかの形でわかるようにし、再実行時はそれを指定することでそこから再実行可能にする
5. 多重起動
  A. 多重起動しないようにロック処理を入れる
  B. 多重起動した場合でも処理結果の整合性を担保する
  C. 処理対象のデータが重ならないようにする
6. 突き抜け対策
  - 処理時間を超えて処理が続いてしまうこと
  - 対策法
    - 本処理自体をチューニングする
      A. N+1となっている処理がないか
      B. アルゴリズムにムダがないか
      C. 大きなメモリコピーがないか
    - 並列に行う / 処理を分割する
      D. 本処理部分をマルチスレッドで処理する
      E. 本処理部分をワーカー化して処理する
      F. 本処理を実行する際、プロセスごとに対象レコードを分ける
      - 上記並列処理を行う際の留意点
        - バッチサーバのCPUコア数
        - 外部通信先の接続制限数
    - バッチ処理プログラム以外の部分で対策する
      G. バッチサーバをスケールアップする
      H. データベースサーバなどのミドルウェアをチューニングする
      I. 要求仕様の一部の実現を諦める